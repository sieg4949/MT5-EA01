EA生成用プロンプト（詳細版）

あなたは MetaTrader 5（MT5）用の Expert Advisor を実装するプロの MQL5 エンジニアです。
以下の仕様に完全準拠し、コンパイルエラーゼロの .mq5 を 1ファイルだけ出力してください。
コード以外の説明文は一切不要です。

1. ベース要件

対象：MT5 / MQL5 専用 EA

#property strict を先頭に宣言

主要イベント：OnInit, OnDeinit, OnTick

ポジション操作は CTrade（#include <Trade/Trade.mqh>）のみを使用

すべてのシグナル判定は
→ 確定バー（M5 / H1 ともに shift=1 のバー）で行うこと
→ 未確定バー（shift=0）の値でシグナルを出さない

通貨ペアは想定として USDJPY（OANDAなど）だが、ペア依存ロジックは禁止
→ pips計算は「小数桁数（_Digits）から自動算出」
→ ハードコーディング禁止

マルチタイムフレーム構成：

H1：相場の文脈／トレンド判定／H1帯・チャネルの計算

M5（チャート時間足）：エントリー／決済のトリガー、実際の発注

複利ロット計算はオプション。デフォルトは固定ロットでよい。

2. 入力パラメータ（Inputs）

すべて input で宣言し、デフォルト値を設定する。

2-1. 一般設定

input double Inp_FixedLot = 0.10;

固定ロット。UseRiskPercent=false のとき有効

input bool Inp_UseRiskPercent = false;

input double Inp_RiskPercent = 1.0;

1トレードあたり口座残高の何%を最大損失とするか（リスクロット方式）

input bool Inp_AllowNewLong = true;

input bool Inp_AllowNewShort = true;

Magic / コメント：

input uint Inp_Magic = 123456;

input string Inp_Comment = "TrendChannelEA";

2-2. 時間帯・ニュースフィルター

input bool Inp_UseSessionFilter = true;

input bool Inp_AllowTokyo = true; // 08:00〜16:00 サーバー時間

input bool Inp_AllowLondon = true; // 16:00〜24:00

input bool Inp_AllowNY = true; // 00:00〜08:00

input bool Inp_UseTimeFilter = false;

input int Inp_TradeStartHour = 0;

input int Inp_TradeEndHour = 24;

input bool Inp_UseNewsFilter = false;

ニュース情報そのものは外部ファイル / グローバル変数などから取得する前提でよい。
→ 実装上は「ニュースフィルタはダミーで false を返す関数」にしておくか、
または Inp_UseNewsFilter が true のときでも、ニュースイベントが一切ない前提で常に通過でもいい（仕様上のフックだけ用意）。

パラメータだけ用意：

input int Inp_NewsMajorMinutes = 60; // 重要指標：前後 60分 禁止

input int Inp_NewsMediumMinutes = 30; // 中程度：前後 30分

input int Inp_NewsMinorMinutes = 5; // 軽微：前後 5分

※ ニュースフィルタの中身はモック実装でよい（将来差し替え前提）。

2-3. スプレッド・約定安全マージン

input bool Inp_UseSpreadFilter = true;

input double Inp_MaxSpreadPoints = 0;

0 の場合は「統計的80%分位×倍率」で自動制御（後述）

input double Inp_SpreadMultiplier = 1.5;

input double Inp_SpreadSafetyBuffer = 1.6;

注文・SL/TP変更・トレール・BE移動時に、この係数を使って
StopLevel や FreezeLevel も踏まえた最小距離を確保する。

3. H1側の分析ロジック
3-1. H1インジケータ

H1タイムフレームで、以下を計算し、最新の確定足（shift=1）の値を M5 から参照する。

close, high, low, open

MA20：単純移動平均（SMA 20）

MA200：SMA 200

ATR14：ATR(14)

BB_BandWidth：(UpperBand - LowerBand) / MA（期間20, 偏差2）

MA20_slope：MA20 の 3本差分：MA20[i] - MA20[i+3] を近似の傾きとして扱う

MA200_slope：MA200 の 6本差分

SwingHigh / SwingLow：直近 50本の高値・安値（iHighest/iLowest 相当）

3-2. H1トレンド判定（UP / DOWN / NONE）

H1確定足で、以下の条件を満たすとき

UP：

MA20_slope > 0

close > MA20

MA200_slope >= 0

DOWN：

MA20_slope < 0

close < MA20

MA200_slope <= 0

上記どちらでもなければ NONE

※ この EA は基本的に トレンドフォロー専用（UP/DOWNのみトレード、NONEは様子見） とする。

3-3. H1ボラ指標

ATR14(H1) の直近 20本分の中央値を求め、
現在 ATR が中央値より低い場合は セットアップ幅を 1.2倍にする（＝帯を広げてチャンスを増やす）。

4. H1バンドによるセットアップ（ベースロジック）

H1側のトレンドに沿って、SwingHigh / SwingLow 周辺にセットアップ帯を定義する。

パラメータ：

input double Inp_SetupWidth_ATR_H1 = 0.35;

計算：

width = Inp_SetupWidth_ATR_H1 * ATR14(H1)

もし ATR14(H1) < ATR14(H1)20本中央値 → width *= 1.2

UPトレンド：

上側帯：UpperBand = SwingHigh ± width
→ 実装では「[SwingHigh - width, SwingHigh + width] の価格帯」に価格が入っているときにARMEDにする

DOWNトレンド：

下側帯：[SwingLow - width, SwingLow + width]

M5側から見ると、

価格がこの帯に入り、ポジションも Pending もないときに「ARMED状態」へ移行する。

5. H1平行チャネルの検出（トレンド中押し目/戻り用）
5-1. Swing点検出（H1）

フラクタル的ルール（k=3）で SwingHigh / SwingLow フラグを設定：

High[i] が i-3〜i+3 の高値の中で最大 → HighSwing

Low[i] が i-3〜i+3 の安値の中で最小 → LowSwing

そこから直近 2点のスイング高・安を取得：

高値：(tH2, pH2)（古い）と (tH1, pH1)（新しい）

安値：(tL2, pL2) と (tL1, pL1)

各2点間の時間差（バー数）が最低3本以上離れていること

5-2. チャネル計算

各2点間で傾き（バーあたり）を算出：

sH = (pH1 - pH2) / (bars_H1間隔)

sL = (pL1 - pL2) / (bars_L1間隔)

最新H1バー（確定足）のインデックス i_now を使い：

upper_now = pH2 + sH * (bars_from_tH2_to_now)

lower_now = pL2 + sL * (bars_from_tL2_to_now)

W = upper_now - lower_now

ATRを使った制約：

atrH1 = ATR14(H1)（最新確定）

0.8 * atrH1 <= W <= 3.0 * atrH1 のときのみ有効

平行性条件：

slope_tol = 0.02 * atrH1

abs(sH - sL) <= slope_tol であること

チャネル品質 ChannelQ（0〜1）を簡易計算：

平行度：q_parallel = 1 - min(1, abs(sH - sL) / slope_tol)

水平／傾き度：q_flat = 1 - min(1, (abs(sH)+abs(sL))/(2*0.03*atrH1))

幅妥当性：q_width = 1 - min(1, abs(W - 1.5*atrH1)/(1.5*atrH1))

総合：ChannelQ = clamp(0, 1, 0.4*q_parallel + 0.2*q_flat + 0.4*q_width)

チャネル有効条件：

ChannelQ >= Inp_ChannelQ_Th のときのみ

UPトレンドなら主に lower_now を、DOWNトレンドなら upper_now を押し目/戻り判定に使う

入力パラメータ：

input double Inp_ChannelQ_Th    = 0.55;
input double Inp_TouchTol_ATR_Tokyo  = 0.22;  // 東京セッション
input double Inp_TouchTol_ATR_Other  = 0.25;  // ロンドン/NY
input int    Inp_RefireCooldown_M5   = 5;     // チャネル押し目/戻りの再試行クールダウン(本)

6. M5でのトリガーロジック
6-1. 共通指標（M5）

MA20(M5)：SMA 20

ATR14(M5)

RCI9(M5)：期間9。相関係数を 100倍したもの（-100〜+100）

6-2. EntryBuffer（ストップエントリのバッファ）

H1セットアップ幅 setup_width = Inp_SetupWidth_ATR_H1 * ATR14(H1) を引数に
EntryBuffer = (0.08 + 0.1 * setup_width) * ATR14(M5) を基準とし、
さらに ATR の分位に応じて段階的に縮小する。

M5 ATRについて、直近20本の中での分位 q（0〜1）を計算し：

q <= 0.3 → reduce_ratio = 0.80（=20%縮小）

0.3 < q <= 0.7 → reduce_ratio = 0.88

q > 0.7 → reduce_ratio = 0.95

EntryBuffer *= reduce_ratio

H1のボリンジャーバンド幅が全期間の低分位（例：20%）以下であれば、
さらにわずかにバッファを増やす（値は固定でよい）。
→ コードに固定係数で追加しておく。

7. トリガー①：H1バンド＋RCI/MA（元からあるトレンド押し目）
7-1. ARMED状態（セットアップ成立）

ポジションもPendingもない状態で：

UP：M5の価格が H1 SwingHigh ± width 帯の中に入ったら ARMED/BUY

DOWN：価格が SwingLow ± width 帯で ARMED/SELL

7-2. トリガー条件（確定M5バー）

RCI系（A）

BUY：

RCI9 <= -80 で「arm」フラグON

その後 RCI9 >= -65 かつ ΔRCI >= dRCI_Threshold で発火
（低ボラ時は dRCI_Threshold * 0.9 で緩和）

SELL：

RCI9 >= +80 → arm

その後 RCI9 <= +65 かつ ΔRCI <= -dRCI_Threshold（低ボラ時は×0.9）

MAタッチ系（B）

price が MA20 ± (MA_Touch_Dev_ATR * ATR14(M5)) に入っている

通常：2本連続でタッチ

強トレンド（H1 MA20_slope の絶対値が全期間上位20%）では1本でもOK

A/Bどちらかが成立し、かつ

ニュースフィルタOK

スプレッドフィルタOK

「ヒゲ比率が大きすぎるバー／異常ボラ」のWick/Volガードで NG でない
→ のとき、トリガー成立とし、後述の Stopエントリーを出す。

7-3. Stopエントリの置き方（H1バンド系）

直近 M5 の Lookback_M5Swing=5 本における高値/安値から：

BUY：stop_price = swing_high + EntryBuffer

SELL：stop_price = swing_low - EntryBuffer

PendingOrder は TTL_short=14 本。満了するとキャンセル。

8. トリガー②：H1平行チャネル押し目/戻り
8-1. 条件（上昇トレンド：押し目BUY）

H1トレンドが UP のとき

H1チャネルが有効（ChannelQ >= Inp_ChannelQ_Th）

M5確定足で：

価格 close が「チャネル下限 lower_now + touchTol * ATR14(M5)」以内

touchTol はセッションで変える：

Tokyoセッション：Inp_TouchTol_ATR_Tokyo（デフォ 0.22）

London/NY：Inp_TouchTol_ATR_Other（デフォ 0.25）

2本分のローソク足で反転を確認：

前足＋今足で

強気包み足（Bullish Engulfing） or

下ヒゲの長いピンバー（Bullish Pin Bar） or

前足で MA20以下 → 今足で MA20上抜け

RCI9 が -50 あたりを下から上へクロス（押し目前提なので閾値をやや緩め）：

RCI_prev < -50 && RCI_curr >= -50

8-2. 下降トレンド：戻りSELL

条件を逆にした対称形：

価格が「チャネル上限 upper_now - touchTol * ATR14(M5)」以内

反転足：強気の逆 → 弱気包み足／上ヒゲピンバー／MA20下抜け など

RCI9 が +50 を上から下へクロス

8-3. Stopエントリー（チャネル押し目/戻り）

BUY：

直近 Lookback_M5Swing 本の高値 swing_high に
stop_price = swing_high + EntryBuffer で BuyStop

SELL：

直近安値 swing_low - EntryBuffer で SellStop

EntryBuffer は H1バンドと同様に ATR分位で縮小するが、チャネル品質に応じて最大6%だけ追加で縮小：

EntryBuffer *= (1 - min(0.06, 0.06 * max(0, ChannelQ - ChannelQ_Th)))

同じ方向のチャネル押し目/戻りエントリは
**Inp_RefireCooldown_M5 本（デフォ5本）**のクールダウンを設ける。

9. ポジション管理・決済ロジック
9-1. エントリー後のSL/TP設定

SL距離：SL_ATR = 1.2 * ATR14(M5)

TP距離：TP_ATR = 1.5 * ATR14(M5)（固定TP）

同方向連続2回目などは 1.4R といった拡張もOKだが、基本は 1.5Rのままとするか、
パラメータ input double Inp_TP_Ratio_First = 1.5; などで固定

ロットサイズ：

Inp_UseRiskPercent == true の場合
→ SL_pips に基づいて「(口座残高 * Risk%) / (SL金額)」でロットを計算し、
ブローカーの LotStep / MinLot / MaxLot に丸める

それ以外は Inp_FixedLot

9-2. MiniTP（部分利確）

エントリー後、R値でモニタリング：

R = (現在価格 - エントリー) / SL距離（BUY）、SELLは逆

条件：

通常トレンド／バンド起点：

MiniTP_R_BO = 0.6R, MiniTP_Frac_BO = 0.30
→ +0.6R 到達時に 30% を利確、残り70%を継続

チャネル押し目/戻りエントリの場合は

MiniTP_R_BO_Pullback = 0.55 とする（固定値でもOK）

部分利確割合は 35% （MiniTP_Frac_BO = 0.35）

9-3. BE（建値ストップ）

BE_Trigger_R = 0.8

Rが +0.8 を超えたら SL を「エントリー価格 ± Inp_BE_Offset_R * SL距離」に移動

デフォルトでは BE_Offset_R = 0（完全建値）

BEは一度だけ実行するフラグを持つ

9-4. TimeStop

1ポジションあたりの最大保有時間：

通常：TimeStop_Trend = 2.0 時間（M5バー換算で24本）

チャネル押し目/戻りエントリの場合：

TimeStop_Pullback = 1.6 時間（約19本）
→ 一定時間以上伸びなければタイムアウトでクローズ
（MarketOrder で成行決済）

10. Bid/Ask・StopLevelの扱い（超重要）

エントリー／決済判定は Bid/Ask を厳密に使うこと

新規注文：

BUY系：Ask基準で Stop/SL/TP の価格を計算

SELL系：Bid基準で計算

ポジションの決済判定：

BUY：

SLヒット：Bid <= SL

TPヒット：Bid >= TP

SELL：

SLヒット：Ask >= SL

TPヒット：Ask <= TP

全ての注文・変更前に

MarketInfo(Symbol(), MODE_STOPLEVEL) 相当（MQL5では SymbolInfoInteger）から StopLevel/FreezeLevel を取得し

SpreadSafetyBuffer も加味して 最小距離を守る。

もし価格が近すぎる場合、注文価格やSL/TPをブローカーが許容する最小距離に丸める。

11. オーダーフィルタ・ポジション制御

常に「同時に1ポジションのみ」に制御（ロング1つ or ショート1つ）

既存ポジションがあるときは新規エントリ禁止

Pending Order は1つまで。約定 or TTL切れで削除。

同一バーで複数のシグナルが出ても、最初の1つだけ採用。

12. ログ・デバッグ機能

input bool Inp_DebugLog = true; を用意。

Inp_DebugLog == true の場合のみ Print() で以下を出力：

エントリー時：トリガー種別（H1Band/ChannelPullback）、方向、SL/TP、R換算距離

MiniTP/BE/TimeStop 発動時

ニュース・スプレッド・Wick/Vol ガードでブロックされた理由

さらに Inp_DebugFile（string）でCSVログ出力オプションがあると望ましいが、必須ではない。

13. 実装上の注意

インジケータの計算は OnTick 内で都度 iXxx を呼ぶのではなく、
CopyRates, CopyBuffer を用いてまとめて取得し、キャッシュして使うように最適化する。

バッファアクセスはすべてエラー確認を行い、失敗時はそのティックでは何もしない。

すべてのループ・配列アクセスに対して、範囲チェックを行うこと。

コードは1ファイルに完結させる（インジケータを別ファイルに分離しない）。

以上の仕様に基づき、
Trendフォロー＋H1バンド押し目／H1平行チャネル押し目・戻りを実装した EA を MQL5 で書いてください。
コードのみを出力し、説明文は一切出力しないでください。