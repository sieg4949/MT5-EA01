【EA仕様詳細プロンプト（現状最新版）】

============================================================
■ 全体構成
============================================================
・本EAは「トレンド（TRD）環境でのみブレイクアウトを狙う」1M/5M/1HマルチタイムEA。
・1Mはシグナル補助、5Mが発注と出口、1Hはレジーム判定・ボラティリティ・重要ピボットに使用。
・エントリーは「TRD環境 + ブレイクアウト + エッジ品質フィルタ」の3条件が揃った時のみ発生。
・出口は STRUCT / BURST / EDGE / SL のハイブリッド方式。
・現状もっとも良好なパラメタセットを本プロンプトにまとめる。

============================================================
■ 1. 時間足データ
============================================================
● M1
・補助的指標のために使用。RSI などの短期モメンタム把握に限定。

● M5（発注・決済に使用）
・OHLC を5分にリサンプル。
・ATR(14) を計算（エントリー逆指値幅などに使用）。
・ema20、RSI3、構造（3本分のHH/LL変化）、edge_base を算出。
・TRDBreakout 判定用に HH/LL（直近6本の高値/安値）を保持。

● H1（環境認識・レジーム・ピボット用）
・ATR(14) を算出（SL距離計算に使用）。
・レジーム(TRD / RNG) を回帰βで判定（48本の線形回帰、標準偏差×係数で閾値）。
・上位ピボット（左右3本条件）の高値ピボット・安値ピボットを検出。

============================================================
■ 2. レジーム判定（H1）
============================================================
方法：48本の回帰傾きβの絶対値が、直近分散に基づく閾値（標準偏差×0.002）を上回れば「TRD」、下回れば「RNG」。

EA動作：
→ エントリーは **TRD のときのみ** 許可。
→ RNG では一切新規を作らない（フェイルブレイクを避ける目的）。

============================================================
■ 3. Edge（エッジ）指標
============================================================
edge_base = 0〜1 の正規化スコア。

構成：
・価格位置（close - EMA20）を ATR で正規化 → 0〜1
・傾き（EMA20 3本差分）を ATR で正規化 → 0〜1
・短期RSI3 → 0〜1
・構造（3本のHH/LLの組み合わせ）→ {0,0.5,1}

重み：
・位置 35%
・傾き 25%
・RSI3 25%
・構造 15%

用途：
・Entry フィルタ：edge_base ≥ **0.60**
・Exit フィルタ：edge_base < **0.28 が3本連続**で EXIT（弱含み持続を検知）

============================================================
■ 4. Entry（逆指値ブレイクアウト）
============================================================
条件：
1) レジーム == TRD  
2) edge_base ≥ 0.60  
3) ATR(14)>0  
4) close > HH または close < LL  
   （HH/LL = 直近6本の高値/安値の最大/最小を1本前にシフト）

注文方式（逆指値）：
● BUY  
   entry_price = HH + EntryBuffer_ATR  
● SELL  
   entry_price = LL - EntryBuffer_ATR  

現行値：
EntryBuffer_ATR = **0.10 × ATR(M5)**

※ 逆指値はスリッページ分の安全マージンとして ATR の一定割合を追加している。

============================================================
■ 5. StopLoss（SL）
============================================================
SL = 上位足(H1)ピボット ± ATR補正

方向別：
● BUY
　候補：直近の「安値ピボット」でエントリー価格より下のもの  
　SL = pivot_low - (SL_extra × ATR_H1)  

● SELL
　候補：直近の「高値ピボット」でエントリー価格より上のもの  
　SL = pivot_high + (SL_extra × ATR_H1)

ピボットが無い場合：
・SL = entry_price ± (2.5 + SL_extra) × ATR_H1  
　（方向に応じて加算/減算）

現行値：
SL_extra = **0.12**

============================================================
■ 6. Exit（決済ロジック：しぐれ版ハイブリッド）
============================================================
出口は以下優先順でチェック。

---------------------------------------
(1) StopLoss（絶対条件）
---------------------------------------
・SL 到達なら即時 EXIT。

---------------------------------------
(2) STRUCT EXIT（構造反転）
---------------------------------------
連続 **3本** の LL（上昇中の下落構造）  
または  
連続 **3本** の HH（下降中の戻り構造）

方向別：
● BUY → 直近3本の low が毎本切り下がっていたら EXIT  
● SELL → 直近3本の high が毎本切り上がっていたら EXIT  

→ トレンド構造の崩壊を検知。

---------------------------------------
(3) BURST EXIT（急反転モメンタム）
---------------------------------------
ΔRSI(3) = RSI3[前のバー] - RSI3[2本前]

BUY：ΔRSI ≤ **–16**  
SELL：ΔRSI ≥ **+16**

→ “急反転だけ” を検知する遅めのBURST。  
→ 通常の押し目では切らないため伸ばし性能が向上。

---------------------------------------
(4) EDGE EXIT（持続的弱化）
---------------------------------------
edge_base < **0.28** が **3本連続** したら EXIT

→ 一時的なノイズでは切らず、「弱い状態が続く」時のみ退出。  
→ トレンドフォロー能力を強化。

---------------------------------------
(5) 終端クローズ
---------------------------------------
最終バーで未決済ならクローズ。

============================================================
■ 7. 出口優先順位まとめ
============================================================
1. SL  
2. STRUCT（3本）  
3. BURST（ΔRSI>=16）  
4. EDGE（0.28×3本）  
5. END

============================================================
■ 8. 期待するEAの動作性（完成像）
============================================================
・TRD時にのみ逆指値ブレイクを行うため、高品質なトレンドの初動・中盤を取る。  
・EntryBuffer=0.10 によりフェイクアウトを軽減しつつ、機会損失を抑制。  
・Exitは「急反転は即逃げ」「構造崩壊は中速」「弱化持続は遅め」で三層防御。  
・トレンド日の伸びを確保しつつ、ノイズ日での損切り連発を減らすバランスに最適化。  
・平均SLが重くなりすぎないよう SL_extra=0.12 と ATR-based pivot を採用。  
・トレールや利確固定は採用せず、構造的な相場変化に基づく“自然な手仕舞い”。

============================================================
■ 9. 推奨パラメタ（現状）
============================================================
EntryBuffer_ATR_M5 = **0.10**  
EdgeEntry_Min = **0.60**  
SL_Extra_ATR_H1 = **0.12**  
STRUCT_LEN = **3**  
BURST_Threshold = **16**  
EDGE_Exit_Threshold = **0.28**  
EDGE_Exit_Consecutive = **3**

============================================================
■ 10. 今後の調整余地
============================================================
・EntryBuffer 0.095〜0.11 の細分調整  
・EdgeEntry 0.575〜0.625 の微調整  
・SL_extra 0.10/0.15 の再テスト  
・EdgeExit(0.26〜0.30 × 3本) の刻み幅調整  
・トレール的な ATR-based exit の追加研究  
・RNG環境でのフィルタ用途（別ロジック化）  

============================================================
以上が、現状最新版のEA仕様プロンプト。
このまま MQL5 化可能。