============================================================
1.	概要
============================================================
1.1 目的
•	人間の裁量トレードを模倣するのではなく、
**「プログラムだからこそできる並列・厳密・一貫したトレード」**を行う EA として設計する。
•	特徴：
o	H1/H4 で相場レジーム（トレンド／レンジ／カオス）を判定
o	M5 で中期的な圧縮・乖離状況を評価
o	M1 でミニスイングの切替を検出し、短期スキャルを行う
o	複数のアルファロジック（AlphaA/B/C）を並列に持ち、
状況に応じて「どのロジックを動かすか／止めるか」を決める
1.2 対象通貨・環境
•	想定メイン通貨ペア：
o	USDJPY（ドル円）
•	サブターゲット（将来的拡張）：
o	EURUSD, EURJPY, GBPUSD
•	口座・ブローカー条件（想定）：
o	スプレッド：0.4 ～ 1.0 pips
o	レイテンシ： 約 184ms
o	取引コスト：手数料込み前提（できれば手数料型口座）
1.3 目標性能
•	対象：USDJPY 単体、1通貨あたりの目標
o	Profit Factor（PF）：1.40 ～ 1.70
o	週トレード数：30 ～ 50 トレード
o	年間トレード数：概ね 1500 ～ 2500
o	最大日次DD目安：-3%以内
o	最大週次DD目安：-5%以内
•	複数通貨運用時：
o	全通貨合算で PF ≧ 1.40 を維持。
o	PF が著しく低い通貨はロットを自動的に 0 に近づける運用を想定（Phase2以降）。
1.4 設計方針（ざっくり）
•	「シグナルの品質」＋「実行品質（コスト・レイテンシ）」＋「リスク管理」を
一体として設計する。
•	“勝てるときにだけ参加し、悪条件では何もしない” を明確にコード化する。
•	過剰最適化を避けるために、閾値は広め・パラメータ数は最小限からスタート。
============================================================
2. 時間足構成とロジック全体像
2.1 時間足の役割
•	H4：大きな流れの補助判断（Trend方向の整合を確認する程度）
•	H1：
o	相場レジーム判定（Trend / Range / Chaos）
o	トレンド方向判定（MA 乖離）
•	M5：
o	圧縮状態の検出（AlphaA）
o	AVWAP（近似VWAP）からの乖離判定（AlphaB）
•	M1：
o	ミニスイングの切替検出（AlphaC）
2.2 ロジック構成
•	Regime Engine（CRegimeEngine）
o	H1/H4 データからレジームを決定
•	Global Gate（CGlobalGate）
o	時間帯・ニュース・スプレッド・ATR 比・DD・FOMO等の共通フィルタ
•	Alpha A：圧縮ブレイク順張り（CAlphaA）
•	Alpha B：AVWAP回帰逆張り（CAlphaB）
•	Alpha C：ミニスイング刈り取り（CAlphaC）
•	Risk Manager（CRiskManager）
o	ロット算出、シグナル優先順位付け、同時建玉制御
•	State Tracker（CStateTracker）
o	日次／週次の損益・DD、各アルファの成績、FOMOタイマー管理
============================================================
3. 取引条件・共通制約
3.1 取引時間帯（ローカル時刻／JST 想定）
•	取引許可時間帯（例）：
o	16:00 ～ 翌 3:00（ロンドン～NY前半）
•	取引禁止時間帯：
o	それ以外の時間帯
o	週末クローズ付近、週明けの窓開け直後 1～2 時間
3.2 ニュースフィルタ（Phase1は簡易版）
•	「ニュース停止時間帯」を手動または外部ファイルで指定可能にする。
•	停止ルール例：
o	指定時刻の ±30 分 は新規エントリ禁止
o	再開条件として、Spread z-score と ATR z-score が一定以下であること
3.3 スプレッド・レイテンシを反映した制約
•	現在スプレッド：SpreadPips
•	M1 ATR：ATR_M1
•	共通ルール：
1.	SpreadPips > InpMaxSpreadPips の場合、新規禁止
2.	SpreadPips / ATR_M1 > InpMaxSpreadATRRatio の場合、新規禁止
3.	TP までの距離（pips）が
MinTargetToSpreadRatio × SpreadPips 未満なら、そのシグナルは捨てる
4.	SL 幅（pips）が 2 × SpreadPips 未満のシグナルは捨てる
3.4 リスク・DD 制御
•	1トレードあたりリスク（％）：
o	初期：0.5% ～ 1.0% 程度を想定
•	DD 制御：
o	日次DDが -2% 到達：新規ロットを 50% に縮小
o	日次DDが -3% 到達：その日の新規エントリを停止
o	週次DDが -5% 到達：翌週まで新規エントリ停止（既存ポジのクローズのみ許可）
============================================================
4. 各モジュール仕様
________________________________________
4.1 CRegimeEngine（レジーム判定）
4.1.1 入力
•	H1 の以下の値（確定足のみ）
o	Close, High, Low, Open
o	MA_fast(20), MA_slow(50)
o	ADX(14)
o	ATR_H1(14)
•	H4 の MA_fast(20), MA_slow(50)（トレンド方向の補助）
4.1.2 内部状態
•	int m_regime;
o	0=Unknown, 1=Trend, 2=Range, 3=Chaos
•	double m_trendDir;
o	-1=Down, 0=Flat, 1=Up
•	datetime m_lastChangeTime;
4.1.3 判定ロジック（簡略版）
•	MA差 = MA_fast - MA_slow
•	MA差ATR比 = |MA差| / ATR_H1
•	条件例（Inputで調整可能）：
o	Trend:
	ADX_H1 > 20
	MA差ATR比 > 0.3
	H1 実体率平均（|Close-Open| / (High-Low)） > 0.4
o	Range:
	ADX_H1 < 15
	MA差ATR比 < 0.2
o	それ以外：Chaos
•	Regimeが変わった場合、m_lastChangeTime を更新し、
RegimeCooldownBars_H1 期間中は新規エントリ制限用フラグを On にする。
________________________________________
4.2 CGlobalGate（全体ゲート）
4.2.1 役割
•	「今この瞬間、どんなに良いシグナルでも新規エントリしてはいけない状況か？」を判定する。
4.2.2 チェック項目
1.	時間帯チェック
o	ローカル時間／サーバー時間＋オフセットで判断
2.	ニュース停止時間帯チェック
3.	スプレッド制限
o	SpreadPips <= InpMaxSpreadPips
o	SpreadPips / ATR_M1 <= InpMaxSpreadATRRatio
4.	DD 状態
o	日次・週次DDが閾値内か
5.	Regime クールダウンフラグ
4.2.3 インターフェース
•	bool CanOpen()
o	true：新規エントリ候補を検討してよい
o	false：新規エントリ禁止（既存ポジの決済や管理は行う）
________________________________________
4.3 CAlphaA（圧縮ブレイク順張り）
4.3.1 対象レジーム
•	Regime == Trend のみ。
4.3.2 使う時間足
•	M5（圧縮＆ブレイク）
•	H1（トレンド方向）
4.3.3 圧縮判定
•	直近 K (=InpA_Lookback_M5) 本の M5 足
o	Range_K = max(High) - min(Low)
o	ATR_M5 = ATR_M5(14)
o	条件：
	Range_K < InpA_Range_ATR_Ratio_Max × ATR_M5
	K 本中のインサイドバー率 > InpA_InsideRateMin
4.3.4 エントリ条件
•	Trend方向にのみエントリ
o	BUY例：
	ConsolidationHigh = 直近K本の高値最大
	BUY STOPを ConsolidationHigh + InpA_EntryOffsetATR × ATR_M5 に設置
•	SL/TP：
o	SL = InpA_SL_ATR × ATR_M5
o	TP1 = InpA_TP1_ATR × ATR_M5 （半分利確）
o	TP2 = トレール（InpA_TP2_TrailATR × ATR_M5）
4.3.5 コスト制約のチェック
•	TP1 までの距離 / SpreadPips >= InpMinTargetToSpreadRatio
•	SLpips >= 2 × SpreadPips
•	上記を満たさない場合、シグナルは生成しない。
________________________________________
4.4 CAlphaB（AVWAP回帰逆張り）
4.4.1 対象レジーム
•	Regime == Range のみ。
4.4.2 擬似AVWAP（当日セッション単位）
•	デイリーバーの開始時間から、M5ごとに以下を更新：
o	AccumPriceTime += Close_M5 * Δt
o	AccumTime += Δt
o	AVWAP = AccumPriceTime / AccumTime
4.4.3 乖離判定
•	D = |Close_M5 - AVWAP|
•	ATR_H1 = ATR_H1(14)
•	D > InpB_Deviation_ATR_H1 × ATR_H1 のとき、行き過ぎと判断。
4.4.4 エントリ
•	AVWAPに戻る方向に逆張り：
o	Priceが AVWAP - 閾値以下 → BUY
o	Priceが AVWAP + 閾値以上 → SELL
•	SL = InpB_SL_ATR_H1 × ATR_H1
•	TP ≒ AVWAP付近（± InpB_TP_Offset_ATR_H1 × ATR_H1）
4.4.5 コスト制約チェック
•	TPまでの距離/SpreadPips >= InpMinTargetToSpreadRatio
•	SLpips >= 2 × SpreadPips
•	条件を満たさない場合、シグナル生成なし。
________________________________________
4.5 CAlphaC（ミニスイング刈り取り）
4.5.1 対象レジーム
•	Regime == Trend or Range（Chaos時は停止 or ロット縮小）
4.5.2 パターン検出（M1）
•	直近 N (=InpC_PatternDepthBars) 本の高値・安値から、
o	高値切り上げ → 切り下げ
o	安値切り下げ → 切り上げ
のような「スイング向きの変化」を検出。
4.5.3 エントリ
•	スイング反転方向へエントリ。
•	SL = InpC_SL_ATR_M1 × ATR_M1
•	TP = InpC_TP_ATR_M1 × ATR_M1
•	最大保有時間：InpC_MaxHoldBars_M1 本を超えた場合、強制クローズ条件を別途持つ。
4.5.4 コスト制約チェック
•	TPまでの距離/SpreadPips >= InpMinTargetToSpreadRatio
•	SLpips >= 2 × SpreadPips
________________________________________
4.6 CRiskManager（ロット・シグナル選別）
4.6.1 ロット計算
•	入力：
o	口座残高、許容リスク%、SL幅（pips）、TickValue、LotStep
•	1トレードあたりの許容損失額 = 残高 × Risk%
•	Lot = 許容損失額 / (SLpips × pips値あたり損益)
•	最小ロット・ステップに合わせて丸める。
4.6.2 シグナル選択
•	同時に複数シグナルが出た場合の優先順位例：
1.	Regimeとの整合性（Trend なら AlphaA 優先、Range なら AlphaB/C 優先）
2.	期待R（TP/SL比）
3.	コスト効率（TP距離/SpreadPips）
4.	同時建玉上限
•	必要なら「1シンボルあたり最大ポジション数」も設定。
4.6.3 FOMOゲート
•	ある Alpha＋方向で損切り／不成立があった場合、
o	M1で X 本のあいだ、その Alpha＋方向の新規エントリ禁止。
•	StateTracker で「最終損切/不成立時間」を記録し、バー数で比較。
________________________________________
4.7 CStateTracker（状態管理）
4.7.1 保持する情報
•	本日の日次損益・DD
•	今週の週次損益・DD
•	各Alphaごとのトレード回数、損益
•	FOMO制御用の最終損切／不成立時刻
•	Spread・ATRの履歴（簡易なログにも使える）
============================================================
5. 課題・リスク（やる前に把握しておくこと）
5.1 実装上の課題
1.	モジュール分割の複雑さ
o	1ファイルEA内にクラスを定義する形になる場合、可読性と依存関係の整理が必要。
2.	M1/M5/H1/H4 のインジケータハンドル管理
o	タイムフレーム混在のインジを使うため、ハンドルと iTime などの整合チェックが必要。
3.	AVWAP擬似実装
o	Tickを使わず M5ベースで近似するため、精度は厳密VWAPより劣る。
o	ただしロジックとしては「基準線」として使えればよい。
5.2 ロジック上の課題
1.	レジーム誤判定
o	Trend/Range の境界で誤判定が起こる。
o	ヒステリシスとクールダウンでノイズを抑える設計にしているが、バックテストで調整必須。
2.	スプレッド・レイテンシの変化
o	実際のスプレッド分布は時間帯・相場で変化する。
o	Spread/ATR 比を用いて自己適応的に制御しているが、ブローカーの特性差には注意。
3.	複数アルファの相関
o	AlphaA/B/C は独立ロジックだが、同じ相場局面で同方向にポジを持つ可能性あり。
o	Phase1 では同時ポジ数制限とレジーム優先度で対処。
5.3 テスト設計上の課題
1.	全ロジック ON でいきなりテストすると、どの部分が原因で悪化したのか追いづらい。
2.	「実行品質」（スリッページ・スプレッド悪化・レイテンシ）の影響がバックテストでは過小評価される。
3.	通貨を増やすとテストケースも爆発するため、Phase1 は USDJPY単体に集中するのが前提。
============================================================
6. テスト計画（しぐれさんがやること）
※ここが特に重要。
※「テスト種別 → やる目的 → 手順 → 判定基準」を明確にしておく。
________________________________________
6.1 テスト全体の流れ（順番）
1.	単体動作テスト（コンパイルと基本動作）
2.	レジーム判定テスト（H1のみ）
3.	GlobalGateテスト（時間・Spread・DDフィルタ確認）
4.	各Alpha単体テスト（A/B/Cを1つずつON）
5.	PF／週トレード数の確認（合成テスト）
6.	フォワードテスト（デモ／低ロット）
以下、それぞれの項目で「しぐれさんがやる手順」を書く。
________________________________________
6.2 単体動作テスト
目的：
•	EAがコンパイルできるか
•	チャートに載せてもエラーを吐かないか
手順：
1.	EA を MT5 に配置し、コンパイル。
2.	USDJPY の M1チャートに EA をセット。
3.	ターミナルの「Experts」タブを確認し、エラーがないかチェック。
4.	しばらく放置し、ログに異常なメッセージ（例外、配列エラー等）が出ないか確認。
判定基準：
•	コンパイルエラー 0。
•	チャートに載せたあと、
o	直後の初期化でエラーなし。
o	数十分動かしてもエラー・例外ログなし。
________________________________________
6.3 レジーム判定テスト
目的：
•	H1ベースで Trend / Range / Chaos が想定通りに切り替わっているかを確認する。
手順：
1.	Strategy Tester で USDJPY H1 単体テストを実行（可視化モード推奨）。
2.	EA には「毎 H1 バー確定時に、Regime と trendDir をコメント or ログ出力する」機能を入れておく。
o	例：[時間][Regime=Trend][Dir=Up] のような行。
3.	過去チャートを目視で確認し、「明らかにトレンド」「明らかにレンジ」の区間を自分でいくつか選ぶ。
4.	選んだ区間のログを確認し、
o	トレンド区間 → Regime=Trend が続いているか
o	レンジ区間 → Regime=Range が多いか
o	急変動区間 → Chaos が含まれているか
5.	必要であれば、ADX閾値・MA差ATR比の各パラメータを少しずつ変えて再テスト。
判定基準：
•	「この区間は典型的な上昇トレンドだろう」というところで Regime=Trend が多く出ている。
•	「ヨコヨコで行ったり来たりしている区間」で Regime=Range が多く出ている。
•	レジーム切替直後に、クールダウンが効いている（即座にシグナル暴発しない）。
________________________________________
6.4 GlobalGate テスト（時間・Spread・DD）
目的：
•	取引してはいけない時間・条件で EA が静かにしているかを確認。
手順：
1.	Strategy Tester の「時間帯」を変えてテスト。
o	例：東京時間だけの期間を切り出してバックテストし、
	取引時間帯を「16:00～3:00」に設定しておく。
2.	Tester の結果で、
o	東京時間のみの期間で ほぼトレードが発生していない ことを確認。
3.	Spread フィルタ：
o	Inputで InpMaxSpreadPips を極端に小さく（例：0.2pips）し、再テスト。
o	ほぼトレードしなくなることを確認。
4.	DD フィルタ：
o	意図的に条件を緩くして負けやすい設定にし、
o	MaxDailyDD を 1% など低い値にしてテスト。
o	一定のDDに達した後、新規トレードが止まるかを確認。
判定基準：
•	禁止時間帯で新規トレードが発生していない。
•	Spread 制約が厳しすぎるとトレード数が激減する（→フィルタが効いている）。
•	DD閾値に達した後、新規トレードが止まり、翌日・翌週に再開している。
________________________________________
6.5 AlphaA 単体テスト（圧縮ブレイク）
目的：
•	圧縮局面 → ブレイク方向にエントリする動きが、仕様通りになっているか確認。
手順：
1.	EAのパラメータで：
o	AlphaA を ON
o	AlphaB, AlphaC を OFF（またはロット0）に設定。
2.	USDJPY, H1/M5 データで数ヶ月のバックテストを実施。
3.	テスターの「結果」「取引履歴」を確認し、
o	エントリ位置をチャート上で確認する。
o	圧縮レンジ（高安が狭い）からのブレイクに乗っているかを目視チェック。
4.	代表的な数トレードを選び、
o	入り方（Stop位置）
o	SL/TP の動き（TP1利確 → 残りトレール）が仕様通りか確認。
判定基準：
•	明らかにボラティリティが高く既に走り切った後に飛び乗るケースが多ければ、EntryOffsetATR を調整。
•	圧縮レンジからの初動に乗るトレードが一定数見られ、
o	勝ちトレード：初動から1.5～2 ATR 取れている
o	負けトレード：すぐ戻されて SL になる（が、FOMOゲートにより追いかけていない）
________________________________________
6.6 AlphaB 単体テスト（AVWAP回帰）
目的：
•	「当日AVWAPから大きく乖離 → 戻る動き」を取れているか確認する。
手順：
1.	AlphaBのみ ON にして、他は OFF。
2.	レンジ相場の期間（上下に振れているが方向性があまりない期間）を選んでバックテスト。
3.	可視化モードで AVWAP ライン（EA内コメント or オブジェクト）を表示させ、
o	価格がAVWAPからどれくらい乖離したときに入っているかを確認。
4.	エントリとエグジットが AVWAP を意識した動きになっているか（戻りで決済されているか）。
判定基準：
•	トレンドが強い日にはほぼ動かず、レンジの日にトレードが多い。
•	エントリは AVWAP ± 約0.9×ATR_H1 より外側から入り、
o	戻りで TP されているケースが一定数ある。
•	トレンド日に逆張り連敗している場合、
o	RegimeEngine の Range 判定が甘すぎる可能性 → パラメータ調整。
________________________________________
6.7 AlphaC 単体テスト（ミニスイング）
目的：
•	M1スイング反転の短期決済が、スプレッド・レイテンシに負けずに機能しているか。
手順：
1.	AlphaC のみ ON。
2.	M1 ベースで数週間のテスト（可能ならテスト期間を短めにして繰り返す）。
3.	可視化モードで、
o	高値・安値の切り替わりタイミングでエントリしているかを確認。
4.	取引履歴から、
o	平均保有バー数（M1バー数）
o	平均R（TP/SL比）
を計算し、期待通り（短時間で完結）になっているかを見る。
判定基準：
•	保有時間が長くなりすぎている（例：何十バーも持つケースが多い）場合、
o	TP/SL やパターン条件の見直しが必要。
•	Spread との比率が悪く、微益か微損ばかりなら、
o	MinTargetToSpreadRatio を上げてシグナルを間引く必要がある。
________________________________________
6.8 合成テスト（AlphaA/B/C 全部ON）
目的：
•	全アルファロジックが同時に動いたときのPF・週トレード数・DDを、目標値と比較する。
手順：
1.	AlphaA/B/C を全て ON。
2.	過去 3〜6 ヶ月分の USDJPY データでバックテスト。
3.	テスターのレポートから以下を確認：
o	PF（Profit Factor）
o	総トレード数
o	期間あたりのトレード数 → 週あたり平均に換算
o	最大連敗数
o	最大DD（％）
4.	トレード履歴を CSV でエクスポートし、Excel 等で
o	日次損益
o	週次損益
o	日次トレード数
を集計する。
判定基準：
•	PF が 1.4 ～ 1.7 の範囲に近いか。
•	週トレード数が 30 ～ 50 に近いか。
•	最大DD が日次 -3% 〜 4%、週次 -5% 〜 7% 程度に納まっているか。
o	※ここから外れていても、どのロジックの貢献が大きい／悪いかを分析して調整していく。
________________________________________
6.9 フォワードテスト（デモ or 超低ロット）
目的：
•	実際のスプレッド・レイテンシ・スリッページを含めた実運用での挙動を確認する。
手順：
1.	デモ口座 or 最小ロットでリアル口座に EA をセット。
2.	1〜2週間ほど放置し、
o	実際の約定履歴（Deal）
o	Spread・Slippage
o	成績（PF、1日あたりトレード数、DD）
を確認。
3.	バックテスト結果と比較し、
o	PF がどの程度劣化するか
o	トレード数／DDの傾向が大きくズレていないか
を見る。
判定基準：
•	バックテスト PF に対して、フォワード PF が 0.2 ～ 0.4 程度下振れても許容。
o	例：BT PF = 1.7 → FW PF = 1.3 くらいなら想定内。
•	トレード数・DD の傾向が概ね近ければ OK。
•	逆に、フォワードで極端に悪化する場合、
o	Spread フィルタや MinTargetToSpreadRatio を見直す必要がある。
============================================================
7. 今後の拡張（Phase2 以降のメモ）
•	Alpha 間の相関を推定し、
相関が高いロジック同士の同時運用を制限する。
•	通貨ペアごとに「成績が悪い通貨のロットを自動的に落とす」バンディット的な配分。
•	AVWAP の精度向上（Tick ベース or より短い時間足統合）。
•	ニュースカレンダーの自動取得（外部ツール or 手動インポート前提）。
•	状態（Regime・Spread帯・時間帯）別の PF ヒートマップを EA から直接出力する仕組み。
============================================================

